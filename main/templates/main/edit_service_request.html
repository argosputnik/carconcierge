{% extends 'main/base.html' %}
{% load static helpers %}

{% block title %}Edit Service Request{% endblock %}

{% block main_class %}main-padded-top{% endblock %}

{% block content %}
<div class="container">
  <h2>Edit Service Request</h2>
  <form method="post">
    {% csrf_token %}

    {# --- Display Non-Field Errors First (Optional but good practice) --- #}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    {# --- Display Customer's Name --- #}
    <div class="mb-3 d-flex align-items-center">
      <label style="width:180px;" class="me-3">Customer</label>
      <input
        type="text"
        class="form-control"
        readonly
        value="{% if service_request.customer %}{{ service_request.customer.get_full_name }}{% else %}Unknown{% endif %}"
      />
    </div>

    {# --- Render Fields in Specific Order --- #}

    {# Function to render a single field (avoids repeating HTML) #}
    {% macro render_field(field, service_request, can_edit_locations) %}
      {% if field %} {# Check if field exists in the form #}
        {% if field.name == 'pickup_location' or field.name == 'dropoff_location' %}
          {# Handle location fields with edit check #}
          {% if can_edit_locations|default:False %}
            <div class="mb-3 d-flex align-items-center">
              <label for="{{ field.id_for_label }}" class="me-3" style="width:180px;">
                {{ field.label }}
              </label>
              {{ field }}
            </div>
          {% else %}
            <div class="mb-3 d-flex align-items-center">
              <label for="{{ field.id_for_label }}" class="me-3" style="width:180px;">
                {{ field.label }}
              </label>
              <input
                type="text"
                name="{{ field.html_name }}"
                readonly
                class="form-control"
                value="{{ service_request.pickup_location if field.name == 'pickup_location' else service_request.dropoff_location }}"
              />
            </div>
          {% endif %}
        {% else %}
          {# Handle other fields normally #}
          <div class="mb-3 d-flex align-items-center">
            <label for="{{ field.id_for_label }}" class="me-3" style="width:180px;">
              {{ field.label }}
            </label>
            {{ field }}
          </div>
        {% endif %}
        {# Display errors right after the field #}
        {% if field.errors %}
          <div class="text-danger mb-2 ms-3">{{ field.errors }}</div>
        {% endif %}
      {% endif %}
    {% endmacro %}

    {# Call the macro for specific fields in order #}
    {{ render_field(form.pickup_location, service_request, can_edit_locations) }}
    {{ render_field(form.dropoff_location, service_request, can_edit_locations) }}
    {{ render_field(form.description, service_request, can_edit_locations) }}

    {# --- Render Remaining Fields --- #}
    {% for field in form %}
      {% if field.name != 'pickup_location' and field.name != 'dropoff_location' and field.name != 'description' %}
         {{ render_field(field, service_request, can_edit_locations) }}
      {% endif %}
    {% endfor %}

    {# --- Map Section --- #}
    <div class="card mb-4">
      <div class="card-header">Location Map</div>
      <div class="card-body">
        <div
          id="map"
          data-address="{{ service_request.pickup_location }}"
          data-share="{{ service_request.share_location|yesno:'true,false' }}"
          data-status="{{ service_request.status }}"
        ></div>
        <div id="map-message" class="alert alert-info mt-2" style="display:none;">
          Finding location...
        </div>
      </div>
    </div>

    {# --- Buttons --- #}
    <button type="submit" class="btn btn-dark">Save Changes</button>
    <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary ms-2">Cancel</a> {# Adjust URL dynamically if needed #}
  </form>
</div>
{% endblock %}

{% block scripts %}
{# Paste the existing script block here #}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const mapEl = document.getElementById("map");
  // Check if mapEl exists before proceeding
  if (!mapEl) {
      console.error("Map element not found!");
      return;
  }

  // Attempt to read canEdit from a data attribute on the form or map, assuming it's passed
  // We need to ensure 'can_edit_locations' is available to the JS if needed
  // Let's assume it's NOT needed for the map display itself, only for form fields
  // const canEdit = mapEl.dataset.canEdit === "true"; // This was in previous JS, ensure data-can-edit is set if needed

  // 1) Initialize map (Leaflet JS/CSS already loaded in base.html)
  const map = L.map("map").setView([0, 0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap contributors"
  }).addTo(map);

  let marker = null;
  const messageEl = document.getElementById("map-message"); // Get message element

  // Function to update map message
  function updateMapMessage(text, type = 'info') {
      if (messageEl) {
          messageEl.textContent = text;
          messageEl.className = `alert alert-${type} mt-2`;
          messageEl.style.display = text ? 'block' : 'none';
      }
  }

  // 2) Geocode address and update map (No reverse geocode needed for display-only map)
  function geocodeAndUpdateMap(address) {
      if (!address || address.trim() === "") {
          console.warn("No pickup address provided for map.");
          updateMapMessage("Pickup address not available.", "warning");
          map.setView([0, 0], 2); // Reset view if no address
          return;
      }

      updateMapMessage("Finding location...", "info"); // Show finding message
      const geocodingAddress = address.replace(/\n/g, ' ').trim();
      console.log("Map attempting to geocode:", geocodingAddress);

      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(geocodingAddress)}&limit=1`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Geocoding HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Map geocoding results:", data);
          if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);

            if (!isNaN(lat) && !isNaN(lon)) {
              console.log(`Map geocoding successful. Coordinates: ${lat}, ${lon}`);
              map.setView([lat, lon], 15);
              if (marker) map.removeLayer(marker); // Remove old marker if exists
              marker = L.marker([lat, lon])
               .addTo(map)
               .bindPopup(`<b>Pickup:</b><br>${address.replace(/\n/g, '<br>')}`)
               .openPopup();
              updateMapMessage("", "info"); // Hide message on success
            } else {
              throw new Error("Invalid coordinates received.");
            }
          } else {
            console.warn("Map geocoding found no results for:", geocodingAddress);
            updateMapMessage(`Could not find location for: "${geocodingAddress}".`, "warning");
          }
        })
        .catch(error => {
          console.error("Map geocoding process error:", error);
          updateMapMessage(`Error finding location: ${error.message}.`, "danger");
        });
  }

  // 3) Get initial address from map element's data attribute
  const initialAddress = mapEl.dataset.address;

  // 4) Initial map setup and geocoding attempt
  // Use requestAnimationFrame to ensure layout is stable before invalidating size
  requestAnimationFrame(() => {
      map.invalidateSize();
      // Delay geocoding slightly to ensure map is ready
      setTimeout(() => geocodeAndUpdateMap(initialAddress), 150);
  });

  // Note: Removed reverse geocoding, marker dragging, and geolocation watching
  // as this seems to be the EDIT form where the map might just be for display.
  // If the map on the EDIT form should be interactive (like the CREATE form),
  // the relevant JS logic needs to be added back.

});
</script>
{% endblock %}
