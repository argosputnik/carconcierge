{% extends 'main/base.html' %}
{% load static helpers %}

{% block title %}Edit Service Request{% endblock %}

{% block main_class %}main-padded-top{% endblock %}

{% block content %}
<div class="container">
  <h2>Edit Service Request</h2>
  <form method="post">
    {% csrf_token %}

    {# --- Display Customer's Name above pickup location --- #}
    <div class="mb-3 d-flex align-items-center">
      <label style="width:180px;" class="me-3">Customer</label>
      <input
        type="text"
        class="form-control"
        readonly
        value="{% if service_request.customer %}{{ service_request.customer.get_full_name }}{% else %}Unknown{% endif %}"
      />
    </div>

    {# --- Display Pickup Location --- #}
    {% for field in form %}
      {% if field.name == 'pickup_location' %}
        {% if can_edit_locations|default:False %}
          <div class="mb-3 d-flex align-items-center">
            <label for="{{ field.id_for_label }}" class="me-3" style="width:180px;">
              {{ field.label }}
            </label>
            {{ field }}
          </div>
        {% else %}
          <div class="mb-3 d-flex align-items-center">
            <label for="{{ field.id_for_label }}" class="me-3" style="width:180px;">
              {{ field.label }}
            </label>
            <input
              type="text"
              name="{{ field.html_name }}"
              readonly
              class="form-control"
              value="{{ service_request.pickup_location }}"
            />
          </div>
        {% endif %}
        {% comment %} Display errors specifically for this field if needed {% endcomment %}
        {% if field.errors %}
          <div class="text-danger mb-2 ms-3">{{ field.errors }}</div>
        {% endif %}
      {% endif %}
    {% endfor %}

    {# --- Display Dropoff Location --- #}
    {% for field in form %}
      {% if field.name == 'dropoff_location' %}
        {% if can_edit_locations|default:False %}
          <div class="mb-3 d-flex align-items-center">
            <label for="{{ field.id_for_label }}" class="me-3" style="width:180px;">
              {{ field.label }}
            </label>
            {{ field }}
          </div>
        {% else %}
          <div class="mb-3 d-flex align-items-center">
            <label for="{{ field.id_for_label }}" class="me-3" style="width:180px;">
              {{ field.label }}
            </label>
            <input
              type="text"
              name="{{ field.html_name }}"
              readonly
              class="form-control"
              value="{{ service_request.dropoff_location }}"
            />
          </div>
        {% endif %}
        {% comment %} Display errors specifically for this field if needed {% endcomment %}
        {% if field.errors %}
          <div class="text-danger mb-2 ms-3">{{ field.errors }}</div>
        {% endif %}
      {% endif %}
    {% endfor %}

    {# --- Display Description Field --- #}
    {% for field in form %}
      {% if field.name == 'description' %}
        <div class="mb-3 d-flex align-items-center">
          <label for="{{ field.id_for_label }}" class="me-3" style="width:180px;">
            {{ field.label }}
          </label>
          {{ field }}
        </div>
        {% comment %} Display errors specifically for this field if needed {% endcomment %}
        {% if field.errors %}
          <div class="text-danger mb-2 ms-3">{{ field.errors }}</div>
        {% endif %}
      {% endif %}
    {% endfor %}

    {# --- Display any additional fields not already handled --- #}
    {% for field in form %}
      {% if field.name != 'pickup_location'
            and field.name != 'dropoff_location'
            and field.name != 'description' %}
        <div class="mb-3 d-flex align-items-center">
          <label for="{{ field.id_for_label }}" class="me-3" style="width:180px;">
            {{ field.label }}
          </label>
          {{ field }}
        </div>
        {# CORRECTED: Error check moved INSIDE the outer 'if' #}
        {% if field.errors %}
          <div class="text-danger mb-2 ms-3">{{ field.errors }}</div>
        {% endif %}
      {% endif %} {# This endif now correctly closes the block containing the error check #}
    {% endfor %}

    <div class="card mb-4">
      {# Wrap map in a card #}
      <div class="card-header">Location Map</div>
      <div class="card-body">
        <div
          id="map"
          data-address="{{ service_request.pickup_location }}"
          data-share="{{ service_request.share_location|yesno:'true,false' }}"
          data-status="{{ service_request.status }}"
        ></div>
        <div id="map-message" class="alert alert-info mt-2" style="display:none;">
          Finding location...
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-dark">Save Changes</button>
    {# Consider making the cancel link dynamic based on user role if needed #}
    <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary ms-2">Cancel</a>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const mapEl = document.getElementById("map");
  // Check if mapEl exists before proceeding
  if (!mapEl) {
      console.error("Map element not found!");
      return;
  }
  
  const canEdit = mapEl.dataset.canEdit === "true";

  // 1) Initialize map (Leaflet JS/CSS already loaded in base.html)
  const map = L.map("map").setView([0, 0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap contributors"
  }).addTo(map);

  let marker = null;

  // 2) Reverse-geocode helper
  function reverseGeocode(lat, lon) {
    fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
    )
      .then(res => {
          if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); }
          return res.json();
      })
      .then(data => {
        const addr = data.display_name || "Address not found"; // Handle cases where display_name might be missing
        const fld = document.getElementById("id_pickup_location");
        // Ensure the field exists before trying to set its value
        if (fld) {
            fld.value = addr;
        } else {
            console.warn("Pickup location field (id_pickup_location) not found.");
        }
        if (marker) {
            marker.bindPopup(addr).openPopup();
        }
      })
      .catch(error => {
          console.error("Reverse geocoding error:", error);
          // Optionally update UI to inform user
      });
  }

  // 3) Place marker (draggable only if allowed)
  function placeMarker(latlng) {
    if (marker) {
        map.removeLayer(marker);
    }
    marker = L.marker(latlng, { draggable: canEdit }).addTo(map);
    reverseGeocode(latlng.lat, latlng.lng); // Get address for the new marker location
    if (canEdit) {
      marker.on("dragend", e => {
        const ll = e.target.getLatLng();
        reverseGeocode(ll.lat, ll.lng); // Update address when dragging stops
      });
    }
  }

  // 4) Seed marker from existing pickup field or browser geolocation
  const pickupFld = document.getElementById("id_pickup_location");
  // Ensure pickupFld exists before accessing its value
  if (pickupFld && pickupFld.value.trim()) {
    const initialAddress = pickupFld.value.trim();
    fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
        initialAddress
      )}&limit=1` // Added limit=1 for efficiency
    )
      .then(res => {
          if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); }
          return res.json();
      })
      .then(data => {
        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          // Validate coordinates
          if (!isNaN(lat) && !isNaN(lon)) {
              map.setView([lat, lon], 15);
              placeMarker(L.latLng(lat, lon));
          } else {
              console.error("Invalid coordinates received from geocoding:", data[0]);
              // Fallback or error message?
          }
        } else {
            console.warn(`Could not geocode initial address: ${initialAddress}`);
            // Fallback to geolocation or default view?
        }
      })
      .catch(error => {
          console.error("Initial geocoding error:", error);
          // Fallback to geolocation or default view?
      });
  } else if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const ll = [pos.coords.latitude, pos.coords.longitude];
        map.setView(ll, 15);
        placeMarker(L.latLng(ll[0], ll[1])); // Place marker and reverse geocode
      },
      geoError => {
          console.error("Geolocation error:", geoError);
          // Set a default view if geolocation fails?
          map.setView([51.505, -0.09], 13); // Example: London
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 } // Geolocation options
    );
  } else {
      // Default view if no address and no geolocation
      console.log("No initial address and geolocation not available. Setting default map view.");
      map.setView([51.505, -0.09], 13); // Example: London
  }

  // 5) Click-to-move marker only if allowed
  if (canEdit) {
    map.on("click", e => {
        // Check if click is on the map itself, not on a marker or control
        if (e.originalEvent.target === map.getContainer()) {
            placeMarker(e.latlng);
        }
    });
  }

  // Invalidate map size after a short delay to ensure container is sized
  setTimeout(() => {
      map.invalidateSize();
  }, 150);

});
</script>
{% endblock %}
