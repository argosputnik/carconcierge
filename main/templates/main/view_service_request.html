{% extends 'main/base.html' %}
{% load static %}

{% block title %}Service Request #{{ service_request.id }}{% endblock %}
{% block main_class %}with-padding{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Service Request Details</h2>

  <div class="d-flex justify-content-center gap-3 mb-3">
    {% include 'main/_dashboard_buttons.html' %}
  </div>

  <!-- 1) DETAILS ABOVE THE MAP -->
  <dl class="row">
    <dt class="col-sm-3">Car</dt>
    <dd class="col-sm-9">{{ service_request.car.license_plate }}</dd>

    <dt class="col-sm-3">Model</dt>
    <dd class="col-sm-9">{{ service_request.model }}</dd>

    <dt class="col-sm-3">Year</dt>
    <dd class="col-sm-9">{{ service_request.year }}</dd>

    <dt class="col-sm-3">Pickup Location</dt>
    <dd class="col-sm-9" style="white-space: pre-line;">
      {{ service_request.pickup_location }}
    </dd>

    <dt class="col-sm-3">Drop-off Location</dt>
    <dd class="col-sm-9" style="white-space: pre-line;">
      {{ service_request.dropoff_location }}
    </dd>

    <dt class="col-sm-3">Job Type</dt>
    <dd class="col-sm-9">{{ service_request.job_type }}</dd>

    <dt class="col-sm-3">Description</dt>
    <dd class="col-sm-9">{{ service_request.description|default:"(none)" }}</dd>

    <dt class="col-sm-3">Status</dt>
    <dd class="col-sm-9">{{ service_request.status }}</dd>

    <dt class="col-sm-3">Assigned To</dt>
    <dd class="col-sm-9">
      {% if service_request.assigned_to %}
        {{ service_request.assigned_to.get_full_name }}
      {% else %}
        (unassigned)
      {% endif %}
    </dd>
  </dl>

  <!-- 2) MAP PULLED FROM PICKUP ADDRESS -->
  <div
    id="map"
    data-address="{{ service_request.pickup_location|escapejs }}"
    style="height: 400px; border:1px solid #ccc; margin-bottom:1rem;"
  ></div>

  <div class="d-flex gap-2">
    <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary">
      ← Back to Dashboard
    </a>
    <a href="{% url 'edit_service_request' service_request.id %}" class="btn btn-primary">
      Edit Request
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <!-- ensure Leaflet JS is loaded here or in your base -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const mapEl   = document.getElementById("map"),
          address = mapEl.dataset.address;

    // 1) initialize map
    const map = L.map("map").setView([0,0], 2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // 2) geocode the pickup address
    if (address) {
      fetch(
        "https://nominatim.openstreetmap.org/search?format=json&q=" +
        encodeURIComponent(address)
      )
      .then(r => r.json())
      .then(results => {
        if (!results.length) return;
        const { lat, lon } = results[0];
        map.setView([lat, lon], 15);
        L.marker([+lat, +lon])
          .addTo(map)
          .bindPopup(address)
          .openPopup();
      })
      .catch(console.error);
    }
  });
  </script>
{% endblock %}
