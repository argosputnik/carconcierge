{% extends 'main/base.html' %}
{% load static %}

{% block title %}Service Request #{{ service_request.id }}{% endblock %}
{% block main_class %}with-padding{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Service Request Details</h2>

  <div class="d-flex justify-content-center gap-3 mb-3">
    {% include 'main/_dashboard_buttons.html' %}
  </div>

  <dl class="row">
    <dt class="col-sm-3">Request ID</dt>
    <dd class="col-sm-9">{{ service_request.id }}</dd>

    <dt class="col-sm-3">Requested At</dt>
    <dd class="col-sm-9">{{ service_request.requested_at|date:"Y‑m‑d H:i" }}</dd>

    <dt class="col-sm-3">Pickup Location</dt>
    <dd class="col-sm-9">{{ service_request.pickup_location }}</dd>

    <dt class="col-sm-3">Dropoff Location</dt>
    <dd class="col-sm-9">{{ service_request.dropoff_location }}</dd>

    <dt class="col-sm-3">Status</dt>
    <dd class="col-sm-9">{{ service_request.status }}</dd>

    <dt class="col-sm-3">Assigned To</dt>
    <dd class="col-sm-9">
      {% if service_request.assigned_to %}
        {{ service_request.assigned_to.get_full_name }}
      {% else %}
        <em>Unassigned</em>
      {% endif %}
    </dd>

    {% if service_request.description %}
      <dt class="col-sm-3">Description</dt>
      <dd class="col-sm-9">{{ service_request.description }}</dd>
    {% endif %}
  </dl>

  <div
    id="map"
    data-address="{{ service_request.pickup_location|escapejs }}"
    data-share="{{ service_request.share_location|yesno:'true,false' }}"
    data-status="{{ service_request.status }}"
    style="height:500px; border:1px solid #ccc;"
  ></div>

  <div class="mt-4">
    <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary me-2">
      ← Back to Dashboard
    </a>
    <a href="{% url 'edit_service_request' service_request.id %}" class="btn btn-primary">
      Edit
    </a>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const mapEl   = document.getElementById("map"),
        address = mapEl.dataset.address,
        share   = mapEl.dataset.share   === "true",
        status  = mapEl.dataset.status,
        role    = "{{ request.user.role }}";

  // 1) Init map & pickup marker
  const map = L.map("map").setView([0,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors"
  }).addTo(map);

  // drop the pickup pin
  if (address) {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
      .then(r => r.json())
      .then(data => {
        if (data.length) {
          const lat = +data[0].lat, lon = +data[0].lon;
          map.setView([lat, lon], 15);
          L.marker([lat, lon])
           .addTo(map)
           .bindPopup(address)
           .openPopup();
        }
      });
  }

  // 2) Live tracking when Delivery
  if (status === "Delivery") {
    // Setup WebSocket connection
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(
      ws_scheme + '://' + window.location.host + 
      '/ws/location/{{ service_request.id }}/'
    );
    
    socket.onopen = function(e) {
      console.log("WebSocket connected");
    };
    
    socket.onclose = function(e) {
      console.log("WebSocket disconnected");
    };
    
    socket.onerror = function(e) {
      console.error("WebSocket error:", e);
    };

    // concierge → show local pin + send coords via WebSocket
    if (role === "concierge" && navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude,
              lng = pos.coords.longitude,
              ll  = [lat, lng];

        // local marker
        if (!window.conciergeMarker) {
          window.conciergeMarker = L.marker(ll, {
            icon: L.icon({
              iconUrl: "{% static 'images/concierge-icon.png' %}",
              iconSize:   [32,32],
              iconAnchor: [16,32]
            })
          })
          .addTo(map)
          .bindPopup("You are here")
          .openPopup();
        } else {
          window.conciergeMarker.setLatLng(ll).openPopup();
        }

        // Send location via WebSocket if connected
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ lat, lng }));
        }
      },
      console.error,
      { enableHighAccuracy: true, maximumAge: 5000 });
    }

    // customer/dealer/owner → receive updates via WebSocket
    else if (share) {
      let customerMarker = null;
      
      // Handle incoming WebSocket messages
      socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.lat && data.lng) {
          const ll = [data.lat, data.lng];
          if (!customerMarker) {
            customerMarker = L.marker(ll, {
              icon: L.icon({
                iconUrl: "{% static 'images/concierge-icon.png' %}",
                iconSize:   [32,32],
                iconAnchor: [16,32]
              })
            })
            .addTo(map)
            .bindPopup("Your Concierge");
            
            // Center map on first location update
            map.setView(ll, 15);
          } else {
            customerMarker.setLatLng(ll);
          }
        }
      };
      
      // Initial location fetch (in case WebSocket connects after location is already set)
      fetch("{% url 'service_request_location' service_request.id %}", {
        credentials: "same-origin"
      })
        .then(r => r.json())
        .then(data => {
          if (data.lat && data.lng) {
            const ll = [data.lat, data.lng];
            if (!customerMarker) {
              customerMarker = L.marker(ll, {
                icon: L.icon({
                  iconUrl: "{% static 'images/concierge-icon.png' %}",
                  iconSize:   [32,32],
                  iconAnchor: [16,32]
                })
              })
              .addTo(map)
              .bindPopup("Your Concierge");
              
              // Center map on initial location
              map.setView(ll, 15);
            }
          }
        })
        .catch(console.error);
    }
  }
});
</script>
{% endblock %}



