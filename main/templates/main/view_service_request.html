{% extends 'main/base.html' %}
{% load static %}

{% block title %}Service Request #{{ service_request.id }}{% endblock %}
{% block main_class %}with-padding{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Service Request #{{ service_request.id }}</h2>

  <div class="d-flex justify-content-center gap-3 mb-3">
    {% include 'main/_dashboard_buttons.html' %}
  </div>

  {# ---------- Edit Form ---------- #}
  <form method="post" id="edit-service-request-form" class="mb-4">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="row g-3">
      <div class="col-md-6">
        {{ form.pickup_location.label_tag }}
        {{ form.pickup_location }}
        {{ form.pickup_location.errors }}
      </div>
      <div class="col-md-6">
        {{ form.dropoff_location.label_tag }}
        {{ form.dropoff_location }}
        {{ form.dropoff_location.errors }}
      </div>
      <div class="col-md-6">
        {{ form.status.label_tag }}
        {{ form.status }}
        {{ form.status.errors }}
      </div>
      <div class="col-md-6">
        {{ form.assigned_to.label_tag }}
        {{ form.assigned_to }}
        {{ form.assigned_to.errors }}
      </div>
      <div class="col-12">
        {{ form.description.label_tag }}
        {{ form.description }}
        {{ form.description.errors }}
      </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Save Changes</button>
  </form>

  {# ---------- Map & Live‐Tracking ---------- #}
  <div
    id="map"
    data-address="{{ service_request.pickup_location|escapejs }}"
    data-share="{{ service_request.share_location|yesno:'true,false' }}"
    data-status="{{ service_request.status }}"
    style="height:500px; border:1px solid #ccc;"
  ></div>

  {# ---------- Multi-line Display ---------- #}
  <address
    class="fs-6 text-muted mt-3"
    style="white-space: pre-line;"
  >
    {{ service_request.pickup_location }}
  </address>

  <div class="mt-4">
    <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary me-2">
      ← Back to Dashboard
    </a>
    <a href="{% url 'edit_service_request' service_request.id %}" class="btn btn-outline-primary">
      Open in Full Edit Page
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const mapEl   = document.getElementById("map"),
        address = mapEl.dataset.address,
        share   = mapEl.dataset.share === "true",
        status  = mapEl.dataset.status,
        role    = "{{ request.user.role }}";

  // 1) Init map
  const map = L.map("map").setView([0,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:"© OpenStreetMap contributors"
  }).addTo(map);

  // 2) Drop customer pickup marker
  if (address) {
    fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
    )
    .then(r=>r.json())
    .then(results=>{
      if (!results.length) return;
      const { lat, lon } = results[0];
      map.setView([lat,lon],15);
      L.marker([+lat,+lon])
        .addTo(map)
        .bindPopup(address)
        .openPopup();
    })
    .catch(console.error);
  }

  // 3) Live‐tracking during Delivery
  if (status === "Delivery") {
    // a) Concierge: watch & POST, show default blue pin
    if (role === "concierge" && navigator.geolocation) {
      navigator.geolocation.watchPosition(pos=>{
        const ll = [pos.coords.latitude, pos.coords.longitude];
        if (!window.conciergeMarker) {
          window.conciergeMarker = L.marker(ll).addTo(map)
            .bindPopup("You are here").openPopup();
        } else {
          window.conciergeMarker.setLatLng(ll).openPopup();
        }
        fetch("{% url 'update_concierge_location' service_request.id %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({ lat: ll[0], lng: ll[1] })
        }).catch(console.error);
      }, console.error, { enableHighAccuracy:true, maximumAge:5000 });
    }
    // b) Customer (or dealer/owner): poll and use same default blue pin
    else if (share) {
      let conciergeMarker = null;
      const poll = () => {
        fetch("{% url 'service_request_location' service_request.id %}")
          .then(r=>r.json())
          .then(data=>{
            if (!data.lat || !data.lng) return;
            const ll = [data.lat, data.lng];
            if (!conciergeMarker) {
              conciergeMarker = L.marker(ll).addTo(map)
                .bindPopup("Your Concierge");
            } else {
              conciergeMarker.setLatLng(ll);
            }
          })
          .catch(console.error);
      };
      poll();
      setInterval(poll, 5000);
    }
  }
});
</script>
{% endblock %}
