{% extends 'main/base.html' %}
{% load static %}

{% block title %}Service Request #{{ service_request.id }}{% endblock %}
{% block main_class %}with-padding{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Service Request Details</h2>

  <div class="d-flex justify-content-center gap-3 mb-3">
    {% include 'main/_dashboard_buttons.html' %}
  </div>

  <dl class="row">
    <dt class="col-sm-3">Request ID</dt>
    <dd class="col-sm-9">{{ service_request.id }}</dd>

    <dt class="col-sm-3">Requested At</dt>
    <dd class="col-sm-9">{{ service_request.requested_at|date:"Y‑m‑d H:i" }}</dd>

    <dt class="col-sm-3">Pickup Location</dt>
    <dd class="col-sm-9">{{ service_request.pickup_location }}</dd>

    <dt class="col-sm-3">Dropoff Location</dt>
    <dd class="col-sm-9">{{ service_request.dropoff_location }}</dd>

    <dt class="col-sm-3">Status</dt>
    <dd class="col-sm-9">{{ service_request.status }}</dd>

    <dt class="col-sm-3">Assigned To</dt>
    <dd class="col-sm-9">
      {% if service_request.assigned_to %}
        {{ service_request.assigned_to.get_full_name }}
      {% else %}
        <em>Unassigned</em>
      {% endif %}
    </dd>

    {% if service_request.description %}
      <dt class="col-sm-3">Description</dt>
      <dd class="col-sm-9">{{ service_request.description }}</dd>
    {% endif %}
  </dl>

  <div
    id="map"
    data-address="{{ service_request.pickup_location|escapejs }}"
    data-share="{{ service_request.share_location|yesno:'true,false' }}"
    data-status="{{ service_request.status }}"
    style="height:500px; border:1px solid #ccc;"
  ></div>

  <div class="mt-4">
    <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary me-2">
      ← Back to Dashboard
    </a>
    <a href="{% url 'edit_service_request' service_request.id %}" class="btn btn-primary">
      Edit
    </a>
  </div>
</div>
{% endblock %}


{% block scripts %}
{% block scripts %}
<script>
// ——— helper to read the CSRF token from the cookie ———
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    for (let cookie of document.cookie.split(';')) {
      cookie = cookie.trim();
      // Does this cookie string begin with the name we want?
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener("DOMContentLoaded", function() {
  const mapEl   = document.getElementById("map"),
        address = mapEl.dataset.address,
        share   = mapEl.dataset.share   === "true",
        status  = mapEl.dataset.status,
        role    = "{{ request.user.role }}";

  // 1) Init map & pickup marker
  const map = L.map("map").setView([0,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors"
  }).addTo(map);

  // drop the pickup pin
  if (address) {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
      .then(r => r.json())
      .then(data => {
        if (data.length) {
          const lat = +data[0].lat, lon = +data[0].lon;
          map.setView([lat, lon], 15);
          L.marker([lat, lon])
           .addTo(map)
           .bindPopup(address)
           .openPopup();
        }
      });
  }

  // 2) Live tracking when Delivery
  if (status === "Delivery") {

    // concierge → show local pin + POST coords to server
    if (role === "concierge" && navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude,
              lng = pos.coords.longitude,
              ll  = [lat, lng];

        // local marker
        if (!window.conciergeMarker) {
          window.conciergeMarker = L.marker(ll, {
            icon: L.icon({
              iconUrl: "{% static 'images/concierge-icon.png' %}",
              iconSize:   [32,32],
              iconAnchor: [16,32]
            })
          })
          .addTo(map)
          .bindPopup("You are here")
          .openPopup();
        } else {
          window.conciergeMarker.setLatLng(ll).openPopup();
        }

        // POST to update_concierge_location with CSRF + credentials
        fetch("{% url 'update_concierge_location' service_request.id %}", {
          method: "POST",
          credentials: "same-origin",               // include cookies
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken":   csrftoken              // valid CSRF
          },
          body: JSON.stringify({ lat, lng })
        })
        .then(r => {
          if (!r.ok) console.error("Update location failed:", r.status);
        })
        .catch(console.error);
      },
      console.error,
      { enableHighAccuracy: true, maximumAge: 5000 });
    }

    // customer/dealer/owner → poll only if share_location is on
    else if (share) {
      let customerMarker = null;
      function fetchConcierge() {
        fetch("{% url 'service_request_location' service_request.id %}", {
          credentials: "same-origin"
        })
          .then(r => r.json())
          .then(data => {
            if (data.lat && data.lng) {
              const ll = [data.lat, data.lng];
              if (!customerMarker) {
                customerMarker = L.marker(ll, {
                  icon: L.icon({
                    iconUrl: "{% static 'images/concierge-icon.png' %}",
                    iconSize:   [32,32],
                    iconAnchor: [16,32]
                  })
                })
                .addTo(map)
                .bindPopup("Your Concierge");
              } else {
                customerMarker.setLatLng(ll);
              }
            }
          })
          .catch(console.error);
      }
      fetchConcierge();
      setInterval(fetchConcierge, 5000);
    }
  }
});
</script>
{% endblock %}



{% endblock %}
