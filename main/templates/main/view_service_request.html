{% extends 'main/base.html' %}
{% load static %}

{% block title %}Service Request #{{ service_request.id }}{% endblock %}

{# Use main_class block to apply padding class to the main element #}
{% block main_class %}main-padded-top{% endblock %}

{% block content %}
<div class="container"> {# Use a container for centering and responsiveness #}
  <h2 class="mb-4 text-center">Service Request Details</h2> {# Added text-center for consistency #}

  <div class="d-flex justify-content-center gap-3 mb-4"> {# Increased bottom margin slightly for separation #}
    {% include 'main/_dashboard_buttons.html' %}
  </div>

  <div class="card mb-4"> {# Wrap details in a card for better visual structure #}
    <div class="card-header">Request Information</div>
    <div class="card-body">
      <dl class="row">
        <dt class="col-sm-3">Request ID</dt>
        <dd class="col-sm-9">{{ service_request.id }}</dd>

        <dt class="col-sm-3">Requested At</dt>
        <dd class="col-sm-9">{{ service_request.requested_at|date:"Y-m-d H:i" }}</dd> {# Corrected date format dash #}

        <dt class="col-sm-3">Pickup Location</dt>
        <dd class="col-sm-9">{{ service_request.pickup_location }}</dd>

        <dt class="col-sm-3">Dropoff Location</dt>
        <dd class="col-sm-9">{{ service_request.dropoff_location }}</dd>

        <dt class="col-sm-3">Status</dt>
        <dd class="col-sm-9">{{ service_request.status }}</dd>

        <dt class="col-sm-3">Assigned To</dt>
        <dd class="col-sm-9">
          {% if service_request.assigned_to %}
            {{ service_request.assigned_to.get_full_name|default:"Assigned User" }} {# Added default #}
          {% else %}
            <em>Unassigned</em>
          {% endif %}
        </dd>

        {% if service_request.description %}
          <dt class="col-sm-3">Description</dt>
          <dd class="col-sm-9">{{ service_request.description }}</dd>
        {% endif %}
      </dl>
    </div>
  </div>


  <div class="card mb-4"> {# Wrap map in a card #}
    <div class="card-header">Location Map</div>
    <div class="card-body">
      <div
        id="map"
        data-address="{{ service_request.pickup_location|escapejs }}"
        data-share="{{ service_request.share_location|yesno:'true,false' }}"
        data-status="{{ service_request.status }}"
        style="height:500px; border:1px solid #ccc;"
      ></div>
      <div id="map-error" class="alert alert-warning mt-2" style="display:none;"></div>
    </div>
  </div>


  <div class="mt-4 text-center"> {# Centered buttons #}
    {# Adjust the back link URL based on the user's role if needed #}
    {% if request.user.role == 'customer' %}
      <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary me-2">
        ← Back to Dashboard
      </a>
    {% elif request.user.role == 'concierge' %}
      <a href="{% url 'concierge_dashboard' %}" class="btn btn-secondary me-2">
        ← Back to Dashboard
      </a>
    {% elif request.user.role == 'dealer' %}
      <a href="{% url 'dealer_dashboard' %}" class="btn btn-secondary me-2">
        ← Back to Dashboard
      </a>
    {% elif request.user.role == 'owner' %}
      <a href="{% url 'owner_dashboard' %}" class="btn btn-secondary me-2">
        ← Back to Dashboard
      </a>
    {% else %}
       {# Default back link if role is not explicitly handled #}
       <a href="{% url 'home' %}" class="btn btn-secondary me-2">
         ← Back
       </a>
    {% endif %}

    {# Check permission before showing edit button - FIXED LIST SYNTAX #}
    {% if request.user == service_request.customer or request.user.role == 'concierge' or request.user.role == 'dealer' or request.user.role == 'owner' %}
      <a href="{% url 'edit_service_request' service_request.id %}" class="btn btn-primary">
        Edit
      </a>
    {% endif %}
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const mapEl = document.getElementById("map");
  const errorEl = document.getElementById("map-error");
  if (!mapEl) return; // Exit if map element doesn't exist

  const address = mapEl.dataset.address,
        share   = mapEl.dataset.share === "true",
        status  = mapEl.dataset.status,
        role    = "{{ request.user.role|escapejs }}"; // Escape role for JS

  console.log("Original address:", address);

  // Initialize map with a default view of the US
  const map = L.map("map").setView([37.0902, -95.7129], 4);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors"
  }).addTo(map);

  // Force a map redraw
  map.invalidateSize();

  // Function to geocode the address
  function geocodeAddress() {
    // Clean up the address for geocoding
    const geocodingAddress = address.replace(/\n/g, ' ').trim();
    console.log("Geocoding address:", geocodingAddress);
    
    // Show loading message
    errorEl.textContent = "Finding location...";
    errorEl.style.display = "block";
    errorEl.className = "alert alert-info mt-2";
    
    // Try to geocode with Nominatim
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(geocodingAddress)}&limit=1`)
      .then(r => {
        if (!r.ok) throw new Error('Geocoding failed with status: ' + r.status);
        return r.json();
      })
      .then(data => {
        console.log("Geocoding results:", data);
        
        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          console.log(`Setting map view to: ${lat}, ${lon}`);
          
          // Set the view and add marker
          map.setView([lat, lon], 15);
          L.marker([lat, lon])
           .addTo(map)
           .bindPopup(`<b>Pickup:</b> ${address}`)
           .openPopup();
          
          // Hide error message
          errorEl.style.display = "none";
        } else {
          console.warn("Geocoding found no results for:", geocodingAddress);
          errorEl.textContent = "Could not find exact location on map. Please check the address.";
          errorEl.className = "alert alert-warning mt-2";
        }
      })
      .catch(error => {
        console.error("Geocoding error:", error);
        errorEl.textContent = "Error finding location: " + error.message;
        errorEl.className = "alert alert-danger mt-2";
      });
  }

  // Try geocoding with a slight delay to ensure map is initialized
  if (address) {
    setTimeout(geocodeAddress, 300);
  } else {
    console.warn("No pickup address provided for geocoding.");
    errorEl.textContent = "No pickup address provided.";
    errorEl.className = "alert alert-warning mt-2";
    errorEl.style.display = "block";
  }

  // 2) Live tracking when Delivery and shared
  if (status === "Delivery" && share) {
    // Setup WebSocket connection
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socketUrl = ws_scheme + '://' + window.location.host +
                      '/ws/location/{{ service_request.id }}/';

    let socket;

    function connectWebSocket() {
      socket = new WebSocket(socketUrl);

      socket.onopen = function(e) {
        console.log("WebSocket connected");
      };

      socket.onclose = function(e) {
        console.log("WebSocket disconnected. Attempting to reconnect...");
        // Attempt to reconnect after a delay
        setTimeout(connectWebSocket, 5000); // Reconnect every 5 seconds
      };

      socket.onerror = function(e) {
        console.error("WebSocket error:", e);
        socket.close(); // Close to trigger reconnect
      };

      // Handle incoming WebSocket messages
      socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.lat && data.lng) {
          const ll = [data.lat, data.lng];
          if (!window.conciergeLocationMarker) { // Use a more specific global variable name
            window.conciergeLocationMarker = L.marker(ll, {
              icon: L.icon({
                iconUrl: "{% static 'images/concierge-icon.png' %}",
                iconSize:   [32,32],
                iconAnchor: [16,32]
              })
            })
            .addTo(map)
            .bindPopup("Concierge Location"); // Added label to popup

            // Center map on first location update, maybe only if not already centered on pickup
             if (!address) { // Only center on concierge if no pickup address was geocoded
                map.setView(ll, 15);
             } else {
                // Optionally adjust view to fit both markers if needed
             }

          } else {
            window.conciergeLocationMarker.setLatLng(ll).openPopup(); // Keep popup open on update
          }
        }
      };
    }

    connectWebSocket(); // Initial connection

    // concierge → show local pin + send coords via WebSocket
    if (role === "concierge" && navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude,
              lng = pos.coords.longitude;

        // Send location via WebSocket if connected
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ lat, lng }));
        }
      },
      console.error,
      { enableHighAccuracy: true, maximumAge: 5000 });
    }

    // customer/dealer/owner → Initial location fetch
    // This fetches the *last known* location when the page loads
    fetch("{% url 'service_request_location' service_request.id %}", {
      credentials: "same-origin"
    })
      .then(r => {
        if (!r.ok) throw new Error('Initial location fetch failed');
        return r.json();
      })
      .then(data => {
        if (data.lat && data.lng) {
          const ll = [data.lat, data.lng];
          if (!window.conciergeLocationMarker) { // Check if marker already created by WebSocket
            window.conciergeLocationMarker = L.marker(ll, {
              icon: L.icon({
                iconUrl: "{% static 'images/concierge-icon.png' %}",
                iconSize:   [32,32],
                iconAnchor: [16,32]
              })
            })
            .addTo(map)
            .bindPopup("Concierge Location");

            // Center map on initial location, maybe only if no pickup address was geocoded
            if (!address) {
               map.setView(ll, 15);
            }
          }
        }
      })
      .catch(console.error);
  } else if (status !== "Delivery") {
    console.log("Location tracking is not active for this request status.");
  } else if (!share) {
    console.log("Location sharing is not enabled for this request.");
  }

  // Invalidate map size on tab/accordion changes if map is in a hidden container initially
  // This is important if the map div is inside a collapsible Bootstrap element
  requestAnimationFrame(() => {
    map.invalidateSize();
  });
});
</script>
{% endblock %}
