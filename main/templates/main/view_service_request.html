{% extends 'main/base.html' %}
{% load static %}

{% block title %}Service Request #{{ service_request.id }}{% endblock %}


{% block content %}
<div class="main-content main-padded-top">
<div class="container">
  <h2 class="mb-4 text-center">Service Request Details</h2>

  <div class="d-flex justify-content-center gap-3 mb-4">
    {% include 'main/_dashboard_buttons.html' %}
  </div>

  <div class="card mb-4">
    <div class="card-header">Request Information</div>
    <div class="card-body">
      <dl class="row">
        <dt class="col-sm-3">Request ID</dt>
        <dd class="col-sm-9">{{ service_request.id }}</dd>

        <dt class="col-sm-3">Requested At</dt>
        <dd class="col-sm-9">{{ service_request.requested_at|date:"Y-m-d H:i" }}</dd>

        <dt class="col-sm-3">Pickup Location</dt>
        <dd class="col-sm-9" style="white-space: pre-line;">{{ service_request.pickup_location }}</dd>

        <dt class="col-sm-3">Dropoff Location</dt>
        <dd class="col-sm-9" style="white-space: pre-line;">{{ service_request.dropoff_location }}</dd>

        <dt class="col-sm-3">Status</dt>
        <dd class="col-sm-9">{{ service_request.status }}</dd>

        <dt class="col-sm-3">Assigned To</dt>
        <dd class="col-sm-9">
          {% if service_request.assigned_to %}
            {{ service_request.assigned_to.get_full_name|default:"Assigned User" }}
          {% else %}
            <em>Unassigned</em>
          {% endif %}
        </dd>

        {% if service_request.description %}
          <dt class="col-sm-3">Description</dt>
          <dd class="col-sm-9">{{ service_request.description }}</dd>
        {% endif %}
      </dl>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Location Map</div>
    <div class="card-body">
      <div
        id="map"
        style="height: 400px;"
        data-pickup="{{ service_request.pickup_location|escapejs }}"
        data-dropoff="{{ service_request.dropoff_location|escapejs }}"
        data-share="{{ service_request.share_location|yesno:'true,false' }}"
        data-status="{{ service_request.status }}"
      ></div>
      <div id="map-message" class="alert alert-info mt-2" style="display:none;">Finding location...</div>
    </div>
  </div>

  <div class="mt-4 text-center">
    {% if request.user.role == 'customer' %}
      <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary me-2">← Back to Dashboard</a>
    {% elif request.user.role == 'concierge' %}
      <a href="{% url 'concierge_dashboard' %}" class="btn btn-secondary me-2">← Back to Dashboard</a>
    {% elif request.user.role == 'dealer' %}
      <a href="{% url 'dealer_dashboard' %}" class="btn btn-secondary me-2">← Back to Dashboard</a>
    {% elif request.user.role == 'owner' %}
      <a href="{% url 'owner_dashboard' %}" class="btn btn-secondary me-2">← Back to Dashboard</a>
    {% else %}
      <a href="{% url 'home' %}" class="btn btn-secondary me-2">← Back</a>
    {% endif %}

    {% if request.user == service_request.customer or request.user.role == 'concierge' or request.user.role == 'dealer' or request.user.role == 'owner' %}
      <a href="{% url 'edit_service_request' service_request.id %}" class="btn btn-primary">Edit</a>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const mapEl = document.getElementById("map");
  const messageEl = document.getElementById("map-message");
  if (!mapEl) return;

  // Get data from attributes
  const pickupAddress = mapEl.dataset.pickup;
  const dropoffAddress = mapEl.dataset.dropoff;
  const share = mapEl.dataset.share === "true";
  const status = mapEl.dataset.status;
  const role = "{{ request.user.role|escapejs }}";

  // Format address for geocoding
  function formatAddress(address) {
    return address
      .split('\n')
      .map(line => line.trim())
      .filter(line => line)
      .join(', ');
  }

  // Initialize map
  const map = L.map("map").setView([41.7151, 44.8271], 12); // Default to Tbilisi
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors",
    maxZoom: 19,
  }).addTo(map);

  // Geocode address and add marker
  async function geocodeAddress(address, markerColor = 'blue', popupTitle = '') {
    const formattedAddress = formatAddress(address);
    if (!formattedAddress) return null;

    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(formattedAddress)}&limit=1`
      );
      
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const data = await response.json();
      
      if (data && data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        
        if (isNaN(lat) || isNaN(lon)) throw new Error("Invalid coordinates received");

        const marker = L.marker([lat, lon], {
          icon: L.icon({
            iconUrl: `{% static 'images/marker-icon-' %}${markerColor}.png`,
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
          })
        }).addTo(map);

        marker.bindPopup(`<b>${popupTitle}</b><br>${address.replace(/\n/g, '<br>')}`);
        return [lat, lon];
      }
      throw new Error("No results found");
    } catch (error) {
      console.error(`Geocoding error for ${popupTitle}:`, error);
      messageEl.textContent = `Could not find location for: "${formattedAddress}". Please verify the address.`;
      messageEl.className = "alert alert-warning mt-2";
      messageEl.style.display = "block";
      return null;
    }
  }

  // Plot both pickup and dropoff locations
  async function plotLocations() {
    messageEl.style.display = "block";
    messageEl.textContent = "Finding locations...";

    const bounds = L.latLngBounds();
    const pickupCoords = await geocodeAddress(pickupAddress, 'blue', 'Pickup Location');
    const dropoffCoords = await geocodeAddress(dropoffAddress, 'red', 'Dropoff Location');

    if (pickupCoords) bounds.extend(pickupCoords);
    if (dropoffCoords) bounds.extend(dropoffCoords);

    if (bounds.isValid()) {
      map.fitBounds(bounds, { padding: [50, 50] });
      messageEl.style.display = "none";
    }
  }

  // Initialize map and plot locations
  requestAnimationFrame(() => {
    map.invalidateSize();
    plotLocations();
  });

  // WebSocket connection for live tracking
  if (status === "Delivery" && share) {
    // ... [Previous WebSocket code remains the same] ...
  }
});
</script>
{% endblock %}
